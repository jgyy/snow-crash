"""Level09 - Position-Based Character Shift Cipher Decoding"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag


def decode_token(token):
	"""Decode position-based character shift cipher."""
	decoded = "".join(chr((ord(c) - i) % 256) for i, c in enumerate(token))
	return "".join(c for c in decoded if c in "abcdefghijklmnopqrstuvwxyz0123456789")


def exploit(host, port, ssh_port, pwd):
	"""Execute cipher decoding and retrieve token."""
	print(f"[*] Connecting to level09@{host}:{ssh_port}")
	if ssh_cmd(host, ssh_port, "level09", pwd, "id")[0] != 0:
		print("[!] SSH connection failed")
		return False, ""

	print("[+] SSH OK\n[*] Reading and decoding token file...")
	code, out, err = ssh_cmd(host, ssh_port, "level09", pwd,
	                          "od -An -tx1 /home/user/level09/token")
	if code != 0:
		print("[!] Failed to read token file")
		return False, ""

	hex_str = out.strip().replace(" ", "").replace("\n", "")
	if not hex_str:
		print("[!] Could not extract hex data")
		return False, ""

	encoded_token = bytes.fromhex(hex_str).decode("latin-1")
	decoded_token = decode_token(encoded_token)
	print(f"[+] Decoded: {decoded_token}\n[*] Authenticating as flag09...")
	code, out, err = ssh_cmd(host, ssh_port, "flag09", decoded_token, "getflag")
	if code != 0:
		print("[!] Failed to authenticate")
		return False, ""

	for line in (out + err).split("\n"):
		if "token" in line.lower():
			for part in line.split():
				if len(part) > 20 and part.isalnum():
					print(f"[+] Success!\n    Token: {part}")
					return True, part
	return False, ""


def main():
	print("Level09 Position-Based Cipher Decoding Exploit\n")
	pwd = read_flag(8)
	success, token = exploit("localhost", 4747, 4242, pwd)

	if success:
		save_flag(9, token)
		print("\n[SUMMARY]\n  Vulnerability: Weak position-based shift cipher")
		print(f"  Attack: Decoded by reversing position index shift\n[ANSWER]\n  Level09 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)


if __name__ == "__main__":
	main()
