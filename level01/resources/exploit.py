"""Level01 - DES Hash Cracker with SSH"""

from passlib.context import CryptContext
import subprocess
import sys

des_ctx = CryptContext(schemes=["des_crypt"], deprecated="auto")


def hash_des(pwd, salt):
    """Hash password using DES crypt."""
    try:
        return des_ctx.hash(pwd, salt=salt)
    except:
        return None


def crack_hash(target, wordlist=None):
    """Crack DES hash using dictionary attack."""
    salt = target[:2]
    common = [
        "abcdefg",
        "password",
        "123456",
        "admin",
        "test",
        "root",
        "flag01",
        "level01",
        "snowcrash",
        "nottoohardhere",
        "qwerty",
        "letmein",
    ]

    print(f"[*] Target: {target} | Salt: {salt}\n")
    for pwd in common:
        if hash_des(pwd[:8], salt) == target:
            print(f"[+] FOUND: {pwd}")
            return pwd
        print(f"    [-] {pwd}")

    if wordlist:
        print(f"\n[*] Wordlist phase...")
        try:
            for line in open(wordlist):
                word = line.strip()[:8]
                if hash_des(word, salt) == target:
                    print(f"[+] FOUND: {word}")
                    return word
        except:
            pass
    return None


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout
    except:
        return -1, ""


def exploit():
    """Execute hash cracking and retrieve token."""
    target_hash = "42hDRfypTqqnw"
    password = crack_hash(target_hash, "/usr/share/dict/words")

    if not password:
        print("[-] Password not found")
        return False, "", ""

    print(f"\n[+] Cracked password: {password}")
    print(f"[*] Connecting to flag01@localhost:4242")
    code, out = ssh_cmd("localhost", 4242, "flag01", password, "getflag")

    if code == 0 and "token" in out.lower():
        print(f"[+] Success!\n{out}")
        token = out.split(":")[-1].strip()
        return True, token, password
    else:
        print(f"[!] Failed")
        return False, "", ""


def main():
    success, token, password = exploit()

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Weak DES crypt hash")
        print(f"  Attack: Dictionary attack on password hash")
        print(f"  Result: Accessed flag01 account\n")
        print(f"[ANSWER]")
        print(f"  Flag01 Password: {password}")
        print(f"  Level01 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
