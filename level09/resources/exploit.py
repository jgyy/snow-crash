"""
Level09 - Position-Based Character Shift Cipher Decoding

Objective:
    Decode position-based character shift cipher to get flag09 password and token.

Vulnerability:
    Weak encryption using position index shift is trivially reversible.

Usage:
    python3 exploit.py
"""

import subprocess
import sys


# ============================================================================
# Helper Functions
# ============================================================================

def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


def decode_token(token):
    """Decode position-based character shift cipher."""
    decoded = ''.join(chr((ord(c) - i) % 256) for i, c in enumerate(token))
    return ''.join(c for c in decoded if c in 'abcdefghijklmnopqrstuvwxyz0123456789')


# ============================================================================
# Exploitation
# ============================================================================

def exploit(host, port, ssh_port, pwd):
    """Execute cipher decoding and retrieve token."""
    print(f"[*] Connecting to level09@{host}:{ssh_port}")
    if ssh_cmd(host, ssh_port, "level09", pwd, "id")[0] != 0:
        print("[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK\n")

    print("[*] Reading and decoding token file...")
    code, out, err = ssh_cmd(host, ssh_port, "level09", pwd,
                             "od -An -tx1 /home/user/level09/token")
    if code != 0:
        print("[!] Failed to read token file")
        return False, ""

    hex_str = out.strip().replace(" ", "").replace("\n", "")
    if not hex_str:
        print("[!] Could not extract hex data")
        return False, ""

    encoded_token = bytes.fromhex(hex_str).decode('latin-1')
    decoded_token = decode_token(encoded_token)
    print(f"[+] Decoded token: {decoded_token}\n")

    print(f"[*] Connecting as flag09 with decoded password...")
    code, out, err = ssh_cmd(host, ssh_port, "flag09", decoded_token, "getflag")
    if code != 0:
        print("[!] Failed to authenticate")
        return False, ""

    for line in (out + err).split("\n"):
        if "token" in line.lower():
            for part in line.split():
                if len(part) > 20 and part.isalnum():
                    print(f"[+] Success!\n    Token: {part}")
                    return True, part

    return False, ""


# ============================================================================
# Main
# ============================================================================

def main():
    print("Level09 Position-Based Cipher Decoding Exploit\n")

    try:
        with open("level08/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level08 token: {pwd}\n")
    except:
        print("[!] Could not read level08 flag")
        sys.exit(1)

    success, token = exploit("localhost", 4747, 4242, pwd)

    if success:
        try:
            with open("level09/flag", "w") as f:
                f.write(token)
            print(f"[+] Token saved to level09/flag")
        except Exception as e:
            print(f"[!] Could not save token: {e}")

        print("\n[SUMMARY]")
        print(f"  Vulnerability: Weak position-based character shift cipher")
        print(f"  Attack: Decoded token by reversing position index shift")
        print(f"  Result: Accessed flag09 account\n")
        print(f"[ANSWER]")
        print(f"  Level09 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
