"""Level02 - PCAP Network Traffic Analyzer with SSH"""

import subprocess
import sys
import os
import tempfile

try:
    import dpkt
except ImportError:
    print("[-] dpkt required: pip install dpkt")
    sys.exit(1)


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command with sshpass."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except Exception as e:
        return -1, "", str(e)


def scp_cmd(host, port, user, pwd, remote_path, local_path):
    """Copy file from remote to local using scp."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "scp",
                "-o",
                "StrictHostKeyChecking=no",
                "-P",
                str(port),
                f"{user}@{host}:{remote_path}",
                local_path,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode == 0
    except Exception as e:
        return False


def parse_pcap(pcap_file):
    """Parse PCAP and extract TCP payloads."""
    packets = []
    with open(pcap_file, "rb") as f:
        for ts, buf in dpkt.pcap.Reader(f):
            try:
                eth = dpkt.ethernet.Ethernet(buf)
                if isinstance(eth.data, dpkt.ip.IP) and isinstance(
                    eth.data.data, dpkt.tcp.TCP
                ):
                    if eth.data.data.data:
                        packets.append(eth.data.data.data)
            except:
                continue
    return packets


def extract_password(payloads):
    """Extract password from telnet session, handling backspace characters."""
    stream = b"".join(payloads)
    clean = bytearray()
    i = 0
    while i < len(stream):
        if stream[i] == 0xFF and i + 1 < len(stream):
            i += 2
        else:
            clean.append(stream[i])
            i += 1

    text = []
    for byte in clean:
        if byte == 0x7F and text:
            text.pop()
        elif 0x20 <= byte < 0x7F:
            text.append(chr(byte))
        elif byte in (0x0A, 0x0D) and text:
            text.append("\n")
    return "".join(text)


def exploit():
    """Extract password from PCAP and retrieve token."""
    print("[*] Level02 PCAP Extractor\n")

    with tempfile.TemporaryDirectory() as tmpdir:
        local_pcap = os.path.join(tmpdir, "level02.pcap")

        print("[*] Attempting to copy PCAP from VM...")

        try:
            level02_pass = open("level01/flag").read().strip()
        except Exception:
            print("[-] Could not read level01/flag")
            return False, "", ""

        locations = [
            "/home/user/level02/level02.pcap",
            "~/level02/level02.pcap",
            "./level02.pcap",
        ]

        found = False
        for location in locations:
            if scp_cmd(
                "localhost",
                4242,
                "level02",
                level02_pass,
                location,
                local_pcap,
            ):
                found = True
                break

        if not found:
            print("[-] Could not copy PCAP from VM")
            return False, "", ""

        print("[+] PCAP copied successfully")

        try:
            os.chmod(local_pcap, 0o644)
        except Exception:
            pass

        print("[*] Analyzing PCAP...")

        try:
            payloads = parse_pcap(local_pcap)
            result = extract_password(payloads)
            password = next(
                (
                    line.split("Password:")[-1].strip()
                    for line in result.split("\n")
                    if "Password:" in line
                ),
                None,
            )

            if not password:
                print("[-] Password not found in PCAP")
                return False, "", ""
        except Exception as e:
            print(f"[-] Error analyzing PCAP: {e}")
            return False, "", ""

        print(f"[+] Password: {password}")
        print(f"[*] Connecting to flag02@localhost:4242")

        code, out, err = ssh_cmd("localhost", 4242, "flag02", password, "getflag")

        if code == 0 and "token" in out.lower():
            print(f"[+] Success!\n{out}")
            token = out.split(":")[-1].strip()
            return True, token, password
        else:
            print("[!] Failed to get flag")
            return False, "", ""


def main():
    success, token, password = exploit()

    if success:
        print(f"[ANSWER]")
        print(f"  Flag02 Password: {password}")
        print(f"  Level02 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
