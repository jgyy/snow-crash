import sys
import string
import os
import tempfile
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, save_flag


def caesar_decrypt(text, shift):
    result = ""
    for char in text:
        if char in string.ascii_letters:
            alpha = string.ascii_uppercase if char.isupper() else string.ascii_lowercase
            result += alpha[(alpha.index(char) - shift) % 26]
        else:
            result += char
    return result


def exploit():
    level00_pwd = "level00"
    print(
        f"[*] Level00 Entry Password: {level00_pwd}\n[*] Copying encrypted password via SCP..."
    )
    with tempfile.TemporaryDirectory() as tmpdir:
        local_file = os.path.join(tmpdir, "john")
        if scp_cmd(
            "localhost",
            4242,
            "level00",
            level00_pwd,
            "/usr/sbin/john",
            local_file,
        ):
            print("[+] File copied")
            os.chmod(local_file, 0o644)
            with open(local_file) as f:
                encrypted = f.read().strip()
                print(f"[+] Encrypted: {encrypted}\n[*] Decoding...")
                flag00_pwd = caesar_decrypt(encrypted, 15)
                print(f"[+] Decoded: {flag00_pwd}\n[*] Connecting as flag00...")
                code, out, err = ssh_cmd(
                    "localhost", 4242, "flag00", flag00_pwd, "getflag"
                )
                if code == 0 and "token" in out.lower():
                    print(f"[+] Success!\n{out}")
                    return True, out.split(":")[-1].strip(), flag00_pwd
                print(f"[!] Failed: {err}")
                return False, "", ""
        print("[-] SCP copy failed")
        return False, "", ""


def main():
    success, token, password = exploit()
    if success:
        save_flag(0, token)
        print(
            f"[SUMMARY]\n  Vulnerability: Caesar cipher (ROT-15)\n  Attack: SCP file transfer, decoded\n[ANSWER]\n  Flag00 Password: {password}\n  Level00 Token: {token}"
        )
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
