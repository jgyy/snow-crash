"""Level00 - Caesar Cipher Decoder with SSH"""

import string
import subprocess
import sys


def caesar_decrypt(text, shift):
    """Decrypt Caesar cipher."""
    result = ""
    for char in text:
        if char in string.ascii_letters:
            alpha = string.ascii_uppercase if char.isupper() else string.ascii_lowercase
            result += alpha[(alpha.index(char) - shift) % 26]
        else:
            result += char
    return result


def ssh_cmd(host, port, user, pwd, cmd):
    """Execute SSH command via sshpass."""
    try:
        result = subprocess.run(
            [
                "sshpass",
                "-p",
                pwd,
                "ssh",
                "-o",
                "StrictHostKeyChecking=no",
                "-p",
                str(port),
                f"{user}@{host}",
                cmd,
            ],
            capture_output=True,
            text=True,
            timeout=10,
        )
        return result.returncode, result.stdout, result.stderr
    except Exception as e:
        return -1, "", str(e)


def exploit():
    """Execute the exploit and retrieve token."""
    encoded = "cdiiddwpgswtgt"
    flag00_pwd = caesar_decrypt(encoded, 15)

    print("[*] Level00 Caesar Cipher Decoder\n")
    print(f"    Encrypted: {encoded}")
    print(f"    Decrypted: {flag00_pwd}\n")

    print(f"[*] Connecting to flag00@localhost:4242")
    code, out, err = ssh_cmd("localhost", 4242, "flag00", flag00_pwd, "getflag")

    if code == 0 and "token" in out.lower():
        print(f"[+] Success!\n{out}")
        token = out.split(":")[-1].strip()
        return True, token, flag00_pwd
    else:
        print(f"[!] Failed: {err}")
        return False, "", ""


def main():
    success, token, password = exploit()

    if success:
        print("\n[SUMMARY]")
        print(f"  Vulnerability: Caesar cipher weak encryption")
        print(f"  Attack: Decoded cipher from readable file")
        print(f"  Result: Accessed flag00 account\n")
        print(f"[ANSWER]")
        print(f"  Flag00 Password: {password}")
        print(f"  Level00 Token: {token}")
    else:
        print("[!] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
